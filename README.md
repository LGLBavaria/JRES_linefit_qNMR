# JRES_linefit_qNMR
This R code provides functions to evaluate J-Resolution 2D NMR-spectra and use the received signal information to create a Line-Fit algorithmn for 1D NMR-spectra. Via PULCON it is possible to quantify analytes within complex matrices by this code combination.

Please cite the following manuscripts if you use the package:
publication will be inserted as soon as it is published

# Usage
## JRES_import()
This function automates the import and referencing of 2D JRES NMR spectra from Bruker instruments. It reads the spectrum using `readBruker()` from the *mrbin* package and extracts the data into a dataframe format. To correct for common referencing issues in automated TopSpin® processing, the function implements a built-in referencing routine based on the internal standard TSP-d4. It automatically detects the TSP singulet using `JRES_peak_picking()` with an adjustable intensity limit (`IntenseLimit`) and `JRES_find_singulet()` within a defined ppm range, adjusts the spectral axes accordingly, and returns the referenced spectrum as a dataframe.
    **Parameters:**

    -   **`path`** (character): A string representing the file path to the JRES spectrum.
    -   **`IntenseLimit`** (numeric, optional): sets the minimal required Intensity for Peaks (Default: 1000)\

## JRES_peak_picking()
    This function identifies peaks in a selected region of a 2D JRES NMR spectrum. It requires the input spectrum and a defined chemical shift range (`ppm_min`, `ppm_max`). Peaks are detected as local maxima that exceed the defined intensity threshold and all surrounding points in a moving search window. Optional parameters allow further control over the horizontal (F2) and vertical (F1) search window size (`horiz_range`, `vert_range`) and a minimum intensity threshold (`IntenseLimit`) to suppress noise artifacts. The optimal intensity threshold strongly depends on the spectrometer setup and should be determined by manually evaluating the intensity range of the background noise.

    **Parameters:**

    -   **`spectrum`** (dataframe): spectrum dataframe imported by `JRES_import()`
    -   **`ppm_max`** (numeric): upper border for the chemical shift (F2) in the evaluated region
    -   **`ppm_min`** (numeric): lower border for the chemical shift (F2) in the evaluated region
    -   **`horiz_range`** (numeric, optional): sets the broadness of the F2-Range used in the identification of local maxima (Peaks) (Default: 20 [datapoints])
    -   **`vert_range`** (numeric, optional): sets the broadness of the F1-Range used in the identification of local maxima (Peaks) (Default: 20 [datapoints])
    -   **`IntenseLimit`** (numeric, optional): sets the minimal required Intensity for Peaks (Default: 1000)

    The function returns a list containing the subset of the spectrum (`sub_spectrum`) and a dataframe of identified peaks (`JRESPeaklist`), including their F1 and F2 positions and intensities.\

## JRES_signal_identification
function explained here
### JRES_find_singulet()
This function verifies whether a peak in a 2D JRES spectrum is a true singlet by checking for its position at F1 = 0 and the absence of coupling signals along the F1 axis. It requires a list of pre-identified peaks (`JRESPeaklist`) and the expected chemical shift of the analyte (`F2shifttarget`). Optional tolerance parameters for both dimensions allow flexibility in signal identification.

    ### Parameters:

    -   **`JRESPeaklist`** (data frame): list of pre-identified peaks. Generated by `JRES_peak_picking()`
    -   **`F2shifttarget`** (numeric): expected chemical shift of the analyte
    -   **`F1shifttol`** (numeric, optional): absolute F1 tolerance used for the definition of singulets/middle peak of uneven multiplets, in ppm (default: 0.0005)
    -   **`F2shifttol`** (numeric, optional): absolute F2 tolerance used for the definition of signals, in ppm (default: 0.001)

The function filters peaks near F1 = 0 and checks whether additional peaks exist within the F2 tolerance at the same shift, indicating multiplicity. Based on the number of matching singulets, appropriate messages and error flags are returned. The result is a list containing the identified singulets, its chemical shift, and error indicators for downstream processing.

    -   `mark_signal_data` (data frame): includes all relevant information for the peaks belonging to the identified signal.
    -   `peak_center` (numeric): signal center on F2-axis/chemical shift
    -   `Error_JRES0` and `Error_JRES1` (logical): error flags\
### JRES_find_even_signal()
This function identifies and verifies multiplets with an even number of components (e.g. doublets, quartets etc.) in JRES spectra. It uses the same core inputs as `JRES_find_singulet()` and requires additional parameters:

    **Parameters:**

    -   **`JRESPeaklist`**: (data frame) list of pre-identified peaks. Generated by `JRES_peak_picking()`
    -   **`F2shifttarget`** (numeric): expected chemical shift of the analyte
    -   **`F1shifttol`** (numeric, optional): absolute F1 tolerance used for the definition of singulets/middle peak of uneven multiplets, in ppm (default: 0.0005)
    -   **`F2shifttol`** (numeric, optional): absolute F2 tolerance used for the definition of signals, in ppm (default: 0.002)
    -   **`multiplicity`** (numeric): expected number of peaks in the signal
    -   **`coupleconst`** (numeric vector): coupling constants relative to signal center
    -   **`coupletol`** (numeric): relative tolerance for coupling match (default: 0.05)
    -   **`check_height`**: (logical, optional): enables intensity check if `TRUE` (default: `FALSE`)
    -   **`heightratio`** (numeric vector): expected relative peak heights
    -   **`heighttol`** (numeric, optional): allowed deviation in relative heights (default: 0.1)

    The function works via several modular subfunctions:

    1.  **`cut_odd_couplings()`**: removes peaks at F1 = 0 including their coupled peaks
    2.  **`filter_even_couplings()`**: creates peak pairs based on F2 proximity
    3.  **`find_even_coupled_signals()`**: groups pairs and checks multiplicity
    4.  **`check_even_coupling()`**: verifies coupling constants relative to signal center
    5.  **`check_height_even_signal()`** *(optional)*: compares measured vs. expected intensity ratios
    6.  **`results_even_signal()`**: final selection of signals based on F2 position (`F2shifttarget`) in case more than one signal fits the criteria. Returns a result list (`result_list`) with:
        -   `mark_signal_data` (data frame): includes all relevant information for the peaks belonging to the identified signal.
        -   `peak_center` (numeric): signal center on F2-axis/chemical shift
        -   `detected_coupling_ppm` (vector, numeric): coupling constants
        -   `Error_JRES0` and `Error_JRES1` (logical): error flags\
### JRES_find_odd_signal()
This function identifies and verifies multiplets with an odd number of components (e.g., triplets etc.) in JRES spectra. Input parameters are identical to those of `JRES_find_even_signal()`, with a slightly different default F2 shift tolerance of `F2shifttol = 0.003`.

    Like the even signal function, it is divided into modular subfunctions for clarity.

    1.  **`cut_even_couplings()`**: removes singlets at F1 = 0 without coupling partners in F2. Requires `JRESPeaklist`, `F1shifttol`, and `F2shifttol`.
    2.  **`filter_odd_couplings()`**: identifies potential coupling partners based on F2 proximity and calculates F1 shift differences.
    3.  **`find_odd_coupled_signals()`**: groups peaks by F2 shift and checks if the number of couplings matches the expected odd multiplicity (see Formula 10).
    4.  **`check_odd_coupling()`**: validates coupling constants against `coupleconst` and `coupletol`. Ensures all expected couplings are present.
    5.  **`check_height_odd_signal()`** *(optional)*: checks relative peak intensities. Same structure as `check_height_even_signal()`.
    6.  **`results_odd_signal()`**: final selection of signals based on F2 position. Returns a result list (`result_list`) with:
        -   `mark_signal_data` (data frame): includes all relevant information for the peaks belonging to the identified signal.

        -   `peak_center` (numeric): signal center on F2-axis/chemical shift

        -   `detected_coupling_ppm` (vector, numeric): coupling constants

        -   `Error_JRES0` and `Error_JRES1` (logical): error flags\
## JRES_plot_spectrum()
This function is used for visualizing a section of a JRES spectrum with optional marking of identified signals. The function starts by converting the spectrum into a long format for visualization using the **ggplot2** package. It then generates a base plot of the spectrum with contour lines and filled regions. If `mark_signal` is set to `TRUE`, the signals stored in `mark_signal_data` are added as marked points. These points are displayed in the specified `mark_color`. Labels for all marked peaks are generated, displaying the chemical shifts (F1ppm and F2ppm) with an offset to prevent label overlap. The function returns the generated visualization object and displays it.

    **Parameters:**

    -   **`sub_spectrum`** (data frame): A data frame containing the spectral data for the region to be displayed. This is a required parameter.
    -   **`mark_signal_data`** (data frame, optional): A data frame containing the identified peaks that are to be marked on the spectrum.
    -   **`sampleID`** (character, optional): A string representing the sample number. This is for labeling purposes.
    -   **`analyte`** (character, optional): The name of the analyte being analyzed. This is for labeling purposes.
    -   **`mark_signal`** (logical, optional): A logical value that indicates whether to mark the identified peaks. The default is `FALSE`. If set to `TRUE`, the peaks in `mark_signal_data` will be marked.
    -   **`mark_color`** (character, optional): The color used to mark the identified peaks. This parameter is only used if `mark_signal` is `TRUE`.
    -   **`mark_rel_x_shift`** (numeric, optional): The relative shift for placing the labels of marked peaks along the x-axis. This helps avoid overlap of labels with the signal.
## integrate_signal()
This function provides a simple method for integrating 1D NMR signals. The function first determines the integration range by selecting all data points within the specified boundaries (`left_range` and `right_range`). It then applies a baseline correction by determining the minimum intensity within the integration range and subtracting it from all intensity values. The integral is then calculated as the sum of the corrected intensities within the selected range.

For visualization, the function creates a data frame and generates a plot using the *ggplot2* package. The plot displays the spectrum as a black line, the integrated area as a blue-shaded region, and the integration boundaries as dashed lines.

    **Parameters:**

    -   `x` (numeric vector): A vector containing the chemical shift values (ppm) corresponding to the NMR signal.

    -   `y` (numeric vector): A vector containing the intensity values corresponding to the chemical shifts in `x`.

    -   `peak_center` (numeric): The position of the peak or integration region center, in ppm.

    -   `left_range` (numeric): The range left of `peak_center`, in ppm.

    -   `right_range` (numeric): The right i of `peak_center`, in ppm.

    -   `sampleID` (character, optional): A string representing the sample number. Used for labeling of the plot.

    -   `analyte` (character, optional): The name of the analyte being studied. Used for labeling of the plot.

    The function returns a result list (`results_integration`) containing:

    -   `integral_value` (numeric): The calculated integral value.

    -   `integral_x` (numeric, vector): The indices of the x-values used for integration.

    -   `integral_y` (numeric, vector): The corrected intensity values within the integration range.

    -   `plot` (plot): The generated plot as an object.

## read_1d_rnmrdata(path)
To read bruker NMR files the package rnmrfit (https://github.com/ssokolen/rnmrfit) is used. 
`read_1d_rnmrdata()` is a modified function to create NMRData1D objects, supplemented by the slot ‘DATA’ which contains the real numbers of the spectrum intensity, adjusted by the scaling factor nc.proc and additional acquisitiondata. The input value is the `path` to the spectra defined as `.../exp_number/`.

## extract_ppm(Spec)
`extract_ppm()` calculates the step size for the ppm axis of the NMRData1D object by the following formula: $spectral width (=Spec.sw)/(number of data points (=Spec.size) -1)$.
Using the calculated step size, the ppm axis is constructed from the maximum ppm value (Spec.maxppm) to the minimum ppm value (Spec.minppm).

## fit_signal()
The function `fit_signal()` is used to precisely analyse NMR spectra by fitting a (or multiple) pseudo-Voigt curve(s) into a baseline corrected spectral area.

$\eta \cdot \left( \frac{a}{1 + \left( \frac{x - x_0}{\gamma} \right)^2 } \right) + (1 - \eta) \cdot \left( a \cdot \exp \left( \frac{-(x - x_0)^2}{2 \sigma^2} \right) \right)$

<sub>η: Ratio of Lorentzian contribution to the pseudo-Voigt function.</sub>  
<sub>1 - η: Ratio of Gaussian contribution to the pseudo-Voigt function.</sub>  
<sub>a: Amplitude of the fit.</sub>  
<sub>x: signal center.</sub>  
<sub>x₀: Peak shift relative to the signal center; the combination of x and x₀ determines the actual peak position.</sub>  
<sub>γ: Half-width of the Lorentzian component.</sub>  
<sub>σ: Half-width of the Gaussian component.</sub>

To optimize the fitting parameters, a genetic algorithm (GA) (https://github.com/luca-scr/GA) was employed. 

The function is expanded to fit multiple peaks by defining their estimated appearance beforehand.

Therefore `fit_signal()` is based on the following required input values:  
`sampleID`: sample ID for visualisation  
`x`: chemical shift of the relevant spectral region  
`y`: signal intensity of this spectral region  
`peaknumber`: defining the amount of peaks fittet; choose from "one", "two", "three", "four", "five", "six", "seven", "eight"  
`peak_center`: center of the signal fit  
`tolerance`: tolerance accepted of the center  
`SF`: spectral frequency of the spectrometer to calculate Hz to ppm  
`peak_shifts_Hz`: Peak position to peak_center in Hz (from lowfield (high ppm) to highfield (low ppm)) without any sign (+/-)  
`area_ratios`: estimated integral ratio (from lowfield (high ppm) to highfield (low ppm))  

optional input values:  
`coupling_tolerance = 0.05`: accepted tolerance of peak_shifts_Hz, default: 0,05 = 5%  
`error_threshold = 0.35 * max(y)`: relative threshold to emphazise smaller errors, default: 35% of maximal signal intensity  
`error_factor = 5`: factor to minimize (<1) or emphazise (>1) errorcalculation of small errors, default: 5  
`minor_signal = F`: possible option to emphazise errorcalculation for minor signals, default: FALSE  
`minor_signal_factor = 0.1`: factor to minimize (<1) or emphazise (>1) errorcalculation for minor signals, default: 0.1  
`minor_signal_threshold = 2`: thershold for usage of minor_signal_factor, default: 2 (double max(y))  
`overfit_cor = F`: possible option to use an extra penalty for signals overfitting the spectral line, default: FALSE  
`overfit_factor = 10`: factor for extra penalty (overfitting the spectral line), default: low = 1, medium = 10, high = 1000  

The output of `fit_signal()` function is a ggplot of the fit in the defined sectral region and a list `fit_result` which contains:  
`$best_params`: optimised fit-parameters    
`fit-values` and `residuals` for the plot  
`integral_value`: total integral  
`mse`: mean squared error of the fit  
`plot`: a ggplot for visualising the fit in the defines spectral region with the spectral line and it's residuals



# Example Spectra and Usage
An example spectra of beer and beer-based mixed beverage is provided.
```
xxx
```
